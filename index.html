<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Super Pr√°tico] Resumo das Regras dos Estados</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 95%;
            width: auto;
            margin-top: 20px;
        }

        #login-screen, #register-screen {
            max-width: 400px;
            width: 100%;
            margin: 50px auto;
        }

        .hidden {
            display: none !important;
        }

        h1, h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }

        form label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        form input[type="text"], 
        form input[type="password"], 
        form select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .user-info {
            font-size: 0.9em;
        }

        /* Tabela de Regras */
        .table-container {
            overflow-x: auto;
        }

        #rules-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #rules-table th, #rules-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap; /* Evita que o texto quebre, mantendo a regra na mesma linha */
        }

        #rules-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #333;
        }

        #rules-table td.rule-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #rules-table td.rule-cell:hover {
            background-color: #e9f5ff;
        }

        .message {
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="container">
        <h1>Login</h1>
        <form id="login-form">
            <label for="username">Usu√°rio:</label>
            <input type="text" id="username" required>

            <label for="password">Senha:</label>
            <input type="password" id="password" required>

            <button type="submit">Entrar</button>
        </form>
        <p>N√£o tem conta? <a href="#" id="show-register">Cadastre-se</a></p>
        <div id="login-message" class="message error hidden"></div>
    </div>

    <div id="register-screen" class="container hidden">
        <h1>Cadastro de Usu√°rio</h1>
        <form id="register-form">
            <label for="reg-username">Novo Usu√°rio:</label>
            <input type="text" id="reg-username" required>

            <label for="reg-password">Nova Senha:</label>
            <input type="password" id="reg-password" required>

            <label for="reg-level">N√≠vel de Acesso:</label>
            <select id="reg-level" required>
                <option value="N1">N1 (Visualiza N2)</option>
                <option value="N2">N2 (Visualiza e Edita)</option>
                <option value="Gestao">Gest√£o (Visualiza e Edita)</option>
            </select>

            <button type="submit">Cadastrar</button>
        </form>
        <p>J√° tem conta? <a href="#" id="show-login">Fazer Login</a></p>
        <div id="register-message" class="message error hidden"></div>
    </div>

    <div id="main-system" class="container hidden">
        <header>
            <h2>Resumo das Regras dos Estados</h2>
            <div class="user-info">
                Bem-vindo(a), <span id="current-user"></span> (<span id="current-level"></span>)
                <button id="logout-button">Sair</button>
            </div>
        </header>

        <div class="table-container">
            <table id="rules-table">
                <thead>
                    <tr id="table-header"></tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>

        <div id="status-message" class="message success hidden"></div>
        <p>
            **Permiss√µes:**
            <ul>
                <li>**N1:** S√≥ pode ver a coluna **'DADOS DA REGRA'** e a coluna do estado de **'PE'** (Pernambuco).</li>
                <li>**N2 e Gest√£o:** Podem ver todas as colunas e **clicar em qualquer regra** para editar.</li>
            </ul>
        </p>
    </div>

    <script>
        // =================================================================
        // DADOS DA PLANILHA ([Super Pr√°tico] Resumo das regras dos Estados - Pr√°tico.csv)
        // =================================================================

        // O cabe√ßalho dos estados (colunas)
        const STATES = ["DADOS DA REGRA", "AL", "PE", "PB", "CE", "RN", "GO", "SE", "BA", "ES", "MA"];

        // A l√≥gica dos dados, onde cada chave √© a "DADOS DA REGRA" e o valor √© um objeto
        // com as chaves dos estados e seus respectivos valores.
        const RULES_DATA = {
            "Data de Corte te√≥rico": {
                "AL": "01/02/2022", "PE": "01/01/2018", "PB": "abr./ 2013", "CE": "13/07/2017", "RN": "11/09/2017", 
                "GO": "22/01/2018", "SE": "-", "BA": "-", "ES": "-", "MA": "-"
            },
            "Data de Corte pr√°tico B": {
                "AL": "31/03/2017", "PE": "01/04/2017 / C, D e E 01/08/2022", "PB": "04/07/2017", "CE": "13/08/2017", "RN": "21/12/2018", 
                "GO": "22/01/2018", "SE": "(Em SERGIPE as datas de corte s√£o por regional) Regional Aracaju e Nossa Senhora do Socorro: 02/05/2019 - Regional Pr√≥pria, Carm√≥polis e N. S. da Gl√≥ria: 03/06/2019 - Regional Itabaiana: 17/06/2019 - Regional Est√¢ncia, Lagarto e Tobias Barreto 01/07/2019", "BA": "15/12/2019", "ES": "-", "MA": "08/05/2023"
            },
            "Data de Corte pr√°tico A": {
                "AL": "01/09/2021", "PE": "02/01/2020", "PB": "14/02/2022", "CE": "10/02/2025 - 4 Cidades do interior ( Sobral, Maranguape, Iguatu e Limoeiro) ** 15/04/2025 - Demais Cidades do interior de CE *** 15/05/2025 - Capital CE- Fortaleza", "RN": "26/04/2021", 
                "GO": "*", "SE": "EM IMPLANTA√á√ÉO", "BA": "24/7/2023", "ES": "-", "MA": "02/10/2024"
            },
            "Tipo de pagamento": {
                "AL": "Vsoft/ Conpay", "PE": "REP / CNH Popular", "PB": "Vsoft/ Hab Social", "CE": "Vsoft(conpay) e Sindgestor", "RN": "Conpay", 
                "GO": "Vsoft/ Bludata/ Hypersoft", "SE": "REP", "BA": "GerenciaNet", "ES": "REP", "MA": "REP"
            },
            "Tipos de sistemas utilizados pelo CFC": {
                "AL": "Pr√°tico/ Validador Thomas Greg", "PE": "Te√≥rico / Pr√°tico", "PB": "Pr√°tico/ iDS CNH/ Validador Biom√©trico/ Captura", "CE": "Te√≥rico/ Pr√°tico", "RN": "Pr√°tico / Te√≥rico (SuperAula e CSA)", 
                "GO": "Te√≥rico/ Pr√°tico/ Validador biom√©trico/ Validador Detran (Sistemas Integrados Detran GO)", "SE": "SuperPr√°tico / Capture (validador biom√©trico) / SuperAula", "BA": "Pr√°tico / Captura Biom√©trica", "ES": "SIT", "MA": "Pr√°tico / Te√≥rico / DetranNET"
            },
            "Quantidade m√≠nima de aulas emitidas em boleto avulso": {
                "AL": "5", "PE": "2", "PB": "5", "CE": "5", "RN": "5", 
                "GO": "5", "SE": "5", "BA": "5", "ES": "-", "MA": "5"
            },
            "Categorias que n√£o precisam de aula noturna": {
                "AL": "N√£o h√° mais a obrigatoriedade para aula noturna em nenhuma categoria", "PE": "Nenhuma das categorias se torna obrigat√≥rio a realiza√ß√£o de aulas noturnas.", "PB": "N√£o h√° mais a obrigatoriedade para aula noturna em nenhuma categoria", "CE": "N√£o h√° mais a obrigatoriedade para aula noturna em nenhuma categoria", "RN": "N√£o h√° mais a obrigatoriedade para aula noturna em nenhuma categoria", 
                "GO": "N√£o h√° mais a obrigatoriedade para aula noturna em nenhuma categoria", "SE": "N√£o precisa de aula noturna em nenhuma categoria", "BA": "-", "ES": "N√£o precisa de aula noturna em nenhuma categoria", "MA": "Sem obrigatoriedade de aula noturna"
            },
            "Aulas simult√¢neas categoria A": {
                "AL": "-", "PE": "-", "PB": "-", "CE": "Atualmente apenas 2 aulas", "RN": "-", 
                "GO": "-", "SE": "-", "BA": "Atualmente apenas 2 aulas", "ES": "-", "MA": "Atualmente apenas 2 aulas"
            },
            "M√°ximo de aulas seguidas": {
                "AL": "2", "PE": "2", "PB": "3", "CE": "2", "RN": "2", 
                "GO": "2", "SE": "2", "BA": "2", "ES": "1", "MA": "2"
            },
            "M√°ximo de aulas por turno": {
                "AL": "2 Aulas em seguidas, descando de 10 minutos para a 3 aula.", "PE": "Nova regra 01/04/2025 M√°ximo de 3 aulas por dia", "PB": "-", "CE": "Nova regra 14/04/2025: Ex: Turno da manha: 2 aulas de 2 Rodas + Intervalo 50 min + 2 aulas de 4 Rodas. 4 aulas mesmo turno portanto que entre elas tenha intervalo de 50 minutos obrigat√≥rios. Ap√≥s realizar essas 4 aulas ele pode fazer mais + 1 aula de Moto üõµ + 1 aula de carro üöô - totalizando por dia 6 aulas", "RN": "3 aulas por categoria (A e B)", 
                "GO": "*", "SE": "3", "BA": "At√© 3 da mesma categoria Ex: 3 de 2R ou 3 de 4R. At√© 3, sendo 1 de categoria distinta. Ex: 2 de 2R + 1 de 4R e vice-versa. At√© 4, sendo 2 de categoria distinta Ex: 2 de 2R + 2 de 4R", "ES": "3", "MA": "3"
            },
            "Intervalo de tempo entre aulas": {
                "AL": "10 minutos de intervalo, sendo aulas do mesmo candidato, sempre que encerrar e abrir nova aula.", "PE": "- Deve haver no m√≠nimo 30min de intervalo de um bloco de aula para outro. Exemplos: - 1¬™ e 2¬™ aulas consecutivas em bloco √∫nico / intervalo m√≠nimo de 30 minutos / 3¬™ aula. - 1¬™ aula / intervalo m√≠nimo de 30 minutos / 2¬™ e 3¬™ aulas consecutivas em bloco √∫nico. - 1¬™ aula / intervalo m√≠nimo de 30 minutos / 2¬™ aula / intervalo m√≠nimo de 30 minutos / 3¬™ aula", "PB": "-", "CE": "Intervalo para iniciar da 2¬™ para a 3¬™ aula -50 minutos", "RN": "50 minutos entre a 1¬™ e 2¬™ (caso haja a 3¬™) ou 50 minutos entre 2¬™ e 3¬™ aula", 
                "GO": "Intervalo para iniciar a 3¬™ aula - 1h", "SE": "Entre a 1¬™ e a 2¬™ n√£o tem. Entre a 2¬™ e a 3¬™, m√≠nimo de 50 minutos.", "BA": "-", "ES": "Da primeira para segunda aula n√£o precisa de intervalo, da segunda para terceira precisa de um intervalo de 50 minutos.", "MA": "-"
            },
            "Tempo minimo regulamentado": {
                "AL": "50 min", "PE": "50 min", "PB": "45 min", "CE": "50 min (5 min toler√¢ncia)", "RN": "50 minutos", 
                "GO": "50 min", "SE": "50 min", "BA": "Diurno: 50 min (10min toler√¢ncia) Noturno: 45 min (10min toler√¢ncia)", "ES": "50 min", "MA": "50 min"
            },
            "In√≠cio do hor√°rio noturno": {
                "AL": "17h(N√£o h√° obrigatoriedade)", "PE": "17h", "PB": "16h (apenas para processos com data de renach anterior a 12/04/2021)", "CE": "17h ( nao tem mais obrigatoriedade)", "RN": "17h (n√£o h√° obrigatoriedade)", 
                "GO": "18h √†s 6h", "SE": "17h (N√£o ha obrigatoriedade)", "BA": "18H", "ES": "17h", "MA": "17h (N√£o ha obrigatoriedade de aula noturna)"
            },
            "Toler√¢ncia entre biometria e SuperPr√°tico": {
                "AL": "-", "PE": "-", "PB": "Simulador: 10 minutos entre biometria e abertura", "CE": "-", "RN": "15 minutos (antes ou depois, no in√≠cio e no fim da aula)", 
                "GO": "*", "SE": "20 minutos", "BA": "-", "ES": "-", "MA": "-"
            },
            "In√≠cio e Fim do hor√°rio das aulas dias √∫teis": {
                "AL": "07h - 22h", "PE": "06h - 22h", "PB": "06h - 21h", "CE": "05:00 as 22:50", "RN": "06:00 √†s 22:00", 
                "GO": "06:00 √†s 21:00 (Na via p√∫blica)", "SE": "06h √†s 21h50", "BA": "06:00 as 23:00", "ES": "06h - 23h", "MA": "06h - 23h"
            },
            "In√≠cio / Fim do hor√°rio das aulas Sab/Dom e feriado": {
                "AL": "07h - 18h", "PE": "06h - 22h", "PB": "06h - 21h", "CE": "Domingo e feriados n√£o √© permitido", "RN": "S√°bado: 06:00 √†s 18:00 // Domingo e feriados n√£o √© permitido", 
                "GO": "06:00 √†s 20:00", "SE": "S√°bados seguem o hor√°rio normal da semana. N√£o √© permitido ministrar aulas aos domingos.", "BA": "S√°bados: das 07h00 √†s 18h00 Domingos: das 07h00 √†s 13h00", "ES": "06h - 23h", "MA": "06h - 23h"
            },
            "OBS: ENVIO DE COLETORES": {
                "AL": "-", "PE": "-", "PB": "-", "CE": "CONTRATO 2R COMODATO - 1 APARELHO INSTRUTOR + 1 APARELHO COLETOR", "RN": "-", 
                "GO": "-", "SE": "Contrato 2R COMODATO: 1 aparelho instrutor + 1 aparelho coletor", "BA": "-", "ES": "-", "MA": "-"
            },
            "Exig√™ncias de conte√∫dos": {
                "AL": "Parada Estacionamento", "PE": "Conceitos B√°sicos", "PB": "Parada Estacionamento", "CE": "Conceitos B√°sicos", "RN": "Parada Estacionamento ( A e B)", 
                "GO": "Conceitos B√°sicos Cat A ( de acordo data corte) e Cat B ( todas datas))", "SE": "Parada e Estacionamento", "BA": "Conceitos B√°sicos", "ES": "*", "MA": "N√£o possui obrigatoriedade/limite de conte√∫do"
            },
            "Cerco Geogr√°fico - Raio:": {
                "AL": "1000", "PE": "1000", "PB": "500", "CE": "Carro: 500 e Moto 5 km", "RN": "500", 
                "GO": "*", "SE": "-", "BA": "500", "ES": "-", "MA": "-"
            },
            "PROCESSO INICIAL (VER TABELA DE AULAS)": {
                "AL": "VER TABELA DE AULAS", "PE": "VER TABELA DE AULAS", "PB": "VER TABELA DE AULAS", "CE": "VER TABELA DE AULAS", "RN": "VER TABELA DE AULAS", 
                "GO": "VER TABELA DE AULAS", "SE": "VER TABELA DE AULAS", "BA": "VER TABELA DE AULAS", "ES": "VER TABELA DE AULAS", "MA": "VER TABELA DE AULAS"
            },
            "Processo Adi√ß√£o (VER TABELA DE AULAS)": {
                "AL": "VER TABELA DE AULAS", "PE": "VER TABELA DE AULAS", "PB": "VER TABELA DE AULAS", "CE": "VER TABELA DE AULAS", "RN": "VER TABELA DE AULAS", 
                "GO": "VER TABELA DE AULAS", "SE": "VER TABELA DE AULAS", "BA": "VER TABELA DE AULAS", "ES": "VER TABELA DE AULAS", "MA": "VER TABELA DE AULAS"
            }
        };

        // SIMULA√á√ÉO DE BANCO DE DADOS DE USU√ÅRIOS (armazenado no localStorage)
        // Estrutura: { username: { password: '...', level: 'N1'/'N2'/'Gestao' } }
        let USERS = {
            'n1user': { password: '123', level: 'N1' }, // Testar com n1user / 123
            'n2user': { password: '123', level: 'N2' }, // Testar com n2user / 123
            'gestao': { password: '123', level: 'Gestao' } // Testar com gestao / 123
        };

        // Carrega dados e usu√°rios do localStorage se existirem
        function loadData() {
            const storedRules = localStorage.getItem('RULES_DATA');
            if (storedRules) {
                // Tenta carregar as regras salvas
                try {
                    Object.assign(RULES_DATA, JSON.parse(storedRules));
                } catch (e) {
                    console.error("Erro ao carregar RULES_DATA do localStorage", e);
                }
            }
            const storedUsers = localStorage.getItem('USERS');
            if (storedUsers) {
                // Tenta carregar os usu√°rios salvos (incluindo os cadastrados na hora)
                try {
                    Object.assign(USERS, JSON.parse(storedUsers));
                } catch (e) {
                    console.error("Erro ao carregar USERS do localStorage", e);
                }
            }
        }

        // Salva dados e usu√°rios no localStorage
        function saveData() {
            localStorage.setItem('RULES_DATA', JSON.stringify(RULES_DATA));
            localStorage.setItem('USERS', JSON.stringify(USERS));
        }

        // =================================================================
        // L√ìGICA DO SISTEMA (JavaScript)
        // =================================================================

        // VARI√ÅVEIS GLOBAIS
        let currentUser = null;
        let currentLevel = null;
        const tableBody = document.getElementById('table-body');
        const tableHeader = document.getElementById('table-header');
        const mainSystem = document.getElementById('main-system');
        const loginScreen = document.getElementById('login-screen');
        const registerScreen = document.getElementById('register-screen');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutButton = document.getElementById('logout-button');
        const loginMessage = document.getElementById('login-message');
        const registerMessage = document.getElementById('register-message');
        const statusMessage = document.getElementById('status-message');

        // --- 1. FUN√á√ïES DE AUTENTICA√á√ÉO E PERMISS√ÉO ---

        function updateAuthDisplay() {
            if (currentUser && currentLevel) {
                loginScreen.classList.add('hidden');
                registerScreen.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                document.getElementById('current-user').textContent = currentUser;
                document.getElementById('current-level').textContent = currentLevel;
                renderRulesTable(); // Renderiza a tabela ap√≥s o login
            } else {
                loginScreen.classList.remove('hidden');
                registerScreen.classList.add('hidden');
                mainSystem.classList.add('hidden');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            loginMessage.classList.add('hidden');

            if (USERS[username] && USERS[username].password === password) {
                currentUser = username;
                currentLevel = USERS[username].level;
                updateAuthDisplay();
            } else {
                loginMessage.textContent = 'Usu√°rio ou senha inv√°lidos.';
                loginMessage.classList.remove('hidden');
                loginMessage.classList.replace('success', 'error');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const level = document.getElementById('reg-level').value;

            registerMessage.classList.add('hidden');

            if (USERS[username]) {
                registerMessage.textContent = 'Usu√°rio j√° existe. Tente outro.';
                registerMessage.classList.remove('hidden');
                registerMessage.classList.replace('success', 'error');
                return;
            }

            if (username && password) {
                USERS[username] = { password, level };
                saveData(); // Salva o novo usu√°rio
                registerForm.reset();
                
                registerMessage.textContent = `Usu√°rio ${username} (${level}) cadastrado com sucesso!`;
                registerMessage.classList.remove('hidden');
                registerMessage.classList.replace('error', 'success');
                
                // Volta para a tela de login
                setTimeout(() => {
                    document.getElementById('show-login').click();
                    registerMessage.classList.add('hidden');
                }, 2000);
            }
        }

        function handleLogout() {
            currentUser = null;
            currentLevel = null;
            updateAuthDisplay();
            loginForm.reset();
        }

        // --- 2. FUN√á√ïES DE RENDERIZA√á√ÉO E EDI√á√ÉO DA TABELA ---

        function renderRulesTable() {
            // Permiss√£o: N1 s√≥ pode ver a coluna 'DADOS DA REGRA' e a coluna 'PE' (Pernambuco).
            // N2 e Gestao podem ver todas.
            const isEditable = currentLevel === 'N2' || currentLevel === 'Gestao';
            const allowedStates = (currentLevel === 'N1') 
                ? STATES.filter(s => s === 'DADOS DA REGRA' || s === 'PE') 
                : STATES;

            // 1. Renderiza o cabe√ßalho (Estados)
            tableHeader.innerHTML = '';
            allowedStates.forEach(state => {
                const th = document.createElement('th');
                th.textContent = state;
                tableHeader.appendChild(th);
            });

            // 2. Renderiza o corpo da tabela
            tableBody.innerHTML = '';
            
            Object.keys(RULES_DATA).forEach(ruleName => {
                const tr = document.createElement('tr');
                
                allowedStates.forEach(state => {
                    const td = document.createElement('td');
                    
                    if (state === 'DADOS DA REGRA') {
                        td.textContent = ruleName;
                        td.style.fontWeight = 'bold';
                    } else {
                        const cellValue = RULES_DATA[ruleName][state] || '-';
                        td.textContent = cellValue;
                        
                        // C√©lulas edit√°veis (N2 e Gest√£o)
                        if (isEditable) {
                            td.classList.add('rule-cell');
                            td.dataset.rule = ruleName;
                            td.dataset.state = state;
                            td.addEventListener('click', handleCellClick);
                        }
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function handleCellClick(event) {
            const td = event.target;
            const ruleName = td.dataset.rule;
            const state = td.dataset.state;
            const originalValue = td.textContent;

            // Se o usu√°rio j√° estiver editando, n√£o faz nada
            if (td.querySelector('textarea')) return;

            // Cria o campo de edi√ß√£o (textarea)
            const textarea = document.createElement('textarea');
            textarea.value = originalValue;
            textarea.style.width = '100%';
            textarea.style.minHeight = '50px';
            textarea.style.boxSizing = 'border-box';

            // Cria os bot√µes
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Salvar';
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancelar';
            cancelButton.style.backgroundColor = '#6c757d'; // Cinza
            cancelButton.style.marginLeft = '5px';

            // Agrupa os bot√µes
            const buttonGroup = document.createElement('div');
            buttonGroup.style.display = 'flex';
            buttonGroup.style.marginTop = '5px';
            buttonGroup.appendChild(saveButton);
            buttonGroup.appendChild(cancelButton);


            // Fun√ß√£o para finalizar a edi√ß√£o
            const finalizeEdit = (newValue = originalValue) => {
                td.textContent = newValue;
                td.removeChild(textarea);
                td.removeChild(buttonGroup);
                td.addEventListener('click', handleCellClick); // Reativa o clique
            };

            // L√≥gica de SALVAR
            saveButton.addEventListener('click', () => {
                const newValue = textarea.value.trim();
                
                // Atualiza a estrutura de dados (RULES_DATA)
                RULES_DATA[ruleName][state] = newValue;
                saveData(); // Salva no localStorage

                // Atualiza a c√©lula e finaliza a edi√ß√£o
                finalizeEdit(newValue);
                
                // Feedback de sucesso
                statusMessage.textContent = `Regra de "${ruleName}" em ${state} atualizada por ${currentUser} (${currentLevel}).`;
                statusMessage.classList.remove('hidden', 'error');
                statusMessage.classList.add('success');
                setTimeout(() => statusMessage.classList.add('hidden'), 5000);
            });
            
            // L√≥gica de CANCELAR
            cancelButton.addEventListener('click', () => {
                finalizeEdit(originalValue);
                statusMessage.classList.add('hidden');
            });


            // Substitui o conte√∫do da c√©lula pelos campos de edi√ß√£o
            td.textContent = '';
            td.removeEventListener('click', handleCellClick);
            td.appendChild(textarea);
            td.appendChild(buttonGroup);
            textarea.focus();
        }

        // --- 3. EVENT LISTENERS E INICIALIZA√á√ÉO ---

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Carrega dados e usu√°rios do localStorage
            updateAuthDisplay();
        });

        // Switch entre Login e Cadastro
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginScreen.classList.add('hidden');
            registerScreen.classList.remove('hidden');
            loginMessage.classList.add('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            registerScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            registerMessage.classList.add('hidden');
        });


        // Login e Logout
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        registerForm.addEventListener('submit', handleRegister);

    </script>
</body>
</html>